[gd_scene load_steps=4 format=4 uid="uid://druxyjpe72edg"]

[ext_resource type="TileSet" uid="uid://dnidij00frbmq" path="res://maps/tilemap/tile_set.tres" id="2_o05f1"]
[ext_resource type="PackedScene" uid="uid://nol6w1l55aah" path="res://entities/player/player_character.tscn" id="5_u1iuh"]

[sub_resource type="GDScript" id="GDScript_u8ri1"]
script/source = "class_name GameMap
extends Node

@export var map_name := \"Map\"

## Parent of all the detectors in the scene
@export var detectors: Node2D

const KEY_BEST_TIME := \"best_time\"
const KEY_BEST_TRAVEL_DISTANCE := \"best_travel_distance\"

var registered_detector_count := 0
var valid_detector_count := 0
var current_map_time := 0.0
var map_save_data: Dictionary

var player_character: PlayerCharacter

func _ready() -> void:	
	for child_node in detectors.get_children():
		var detector = child_node as Detector
		if detector:
			registered_detector_count += 1
			detector.validity_changed.connect(_on_detector_validity_changed)
	
	for child_node in get_children():
		var pc := child_node as PlayerCharacter
		if pc:
			player_character = pc
	
	Main.map_loaded(self)
	HUD.show_map_info(self)
	HUD.show_map_detector_count(
		valid_detector_count, registered_detector_count
	)	

func _process(delta: float) -> void:
	current_map_time += delta
	HUD.show_map_time(current_map_time)


func _on_detector_validity_changed(valid: bool) -> void:
	if valid:
		valid_detector_count += 1
		if valid_detector_count == registered_detector_count:
			_update_best_scores()
			Main.load_next_map()
	else:
		valid_detector_count -= 1
	HUD.show_map_detector_count(
		valid_detector_count, registered_detector_count
	)

func _update_best_scores() -> void:
	var new_time := floori(current_map_time)
	if (
			not map_save_data.has(KEY_BEST_TIME)
			or new_time < map_save_data[KEY_BEST_TIME]
	):
		map_save_data[KEY_BEST_TIME] = new_time
	else:
		new_time = -1

	var new_travel_distance := floori(player_character.travel_distance)
	if (
			not map_save_data.has(KEY_BEST_TRAVEL_DISTANCE)
			or new_travel_distance < map_save_data[KEY_BEST_TRAVEL_DISTANCE]
	):
		map_save_data[KEY_BEST_TRAVEL_DISTANCE] = new_travel_distance
	else:
		new_travel_distance = -1

	HUD.show_map_best_scores(new_time, new_travel_distance)
"

[node name="Map" type="Node" node_paths=PackedStringArray("detectors")]
script = SubResource("GDScript_u8ri1")
map_name = "Map 1"
detectors = NodePath("")

[node name="TileMap" type="TileMapLayer" parent="."]
texture_filter = 1
tile_map_data = PackedByteArray("AAAAAAAAAAACAAAAAAABAAAAAAABAAAAAAACAAAAAAAAAAAAAAADAAAAAAABAAAAAAAEAAAAAAABAAAAAAAFAAAAAAABAAAAAAAGAAAAAAABAAAAAAAHAAAAAAACAAAAAAAIAAAAAAAAAAAAAAAJAAAAAAAAAAAAAAAKAAAAAAABAAAAAAALAAAAAAABAAAAAAAMAAAAAAABAAAAAAANAAAAAAAAAAAAAAAOAAAAAAACAAAAAAAPAAAAAAACAAAAAAAQAAAAAAABAAAAAAARAAAAAAACAAAAAAASAAAAAAAAAAAAAAATAAAAAAACAAAAAAAUAAAAAAACAAAAAAAVAAAAAAACAAAAAAAWAAAAAAABAAAAAAAXAAAAAAACAAAAAAAYAAAAAAACAAAAAAAYAAEAAAACAAAAAAAYAAIAAAABAAAAAAAYAAMAAAABAAAAAAAYAAQAAAAAAAAAAAAYAAUAAAABAAAAAAAYAAYAAAACAAAAAAAYAAcAAAABAAAAAAAYAAgAAAAAAAAAAAAYAAkAAAAAAAAAAAAYAAoAAAACAAAAAAAYAAsAAAABAAAAAAAYAAwAAAABAAAAAAAYAA0AAAACAAAAAAAYAA4AAAACAAAAAAAXAA4AAAACAAAAAAAWAA4AAAABAAAAAAAVAA4AAAAAAAAAAAAUAA4AAAACAAAAAAATAA4AAAABAAAAAAASAA4AAAACAAAAAAARAA4AAAACAAAAAAAQAA4AAAAAAAAAAAAPAA4AAAACAAAAAAAOAA4AAAACAAAAAAANAA4AAAABAAAAAAAMAA4AAAACAAAAAAALAA4AAAACAAAAAAAKAA4AAAAAAAAAAAAJAA4AAAAAAAAAAAAIAA4AAAAAAAAAAAAHAA4AAAACAAAAAAAGAA4AAAACAAAAAAAFAA4AAAAAAAAAAAAEAA4AAAABAAAAAAADAA4AAAABAAAAAAACAA4AAAACAAAAAAABAA4AAAACAAAAAAAAAA4AAAAAAAAAAAAAAA0AAAABAAAAAAAAAAwAAAAAAAAAAAAAAAsAAAAAAAAAAAAAAAoAAAABAAAAAAAAAAkAAAACAAAAAAAAAAgAAAABAAAAAAAAAAcAAAAAAAAAAAAAAAYAAAABAAAAAAAAAAUAAAAAAAAAAAAAAAQAAAACAAAAAAAAAAMAAAAAAAAAAAAAAAIAAAACAAAAAAAAAAEAAAAAAAAAAAABAAEAAAAAAAEAAAABAAIAAAABAAEAAAABAAMAAAABAAEAAAABAAQAAAAAAAEAAAABAAUAAAACAAEAAAABAAYAAAAAAAEAAAABAAcAAAACAAEAAAABAAgAAAABAAIAAAABAAkAAAABAAIAAAABAAoAAAACAAIAAAABAAsAAAAAAAIAAAABAAwAAAACAAIAAAABAA0AAAABAAIAAAACAAEAAAAAAAEAAAACAAIAAAACAAEAAAACAAMAAAAAAAEAAAACAAQAAAABAAEAAAACAAUAAAAAAAEAAAACAAYAAAAAAAEAAAACAAcAAAACAAEAAAACAAgAAAACAAIAAAACAAkAAAABAAIAAAACAAoAAAAAAAIAAAACAAsAAAAAAAIAAAACAAwAAAABAAIAAAACAA0AAAABAAIAAAADAAEAAAAAAAEAAAADAAIAAAABAAEAAAADAAMAAAACAAEAAAADAAQAAAACAAEAAAADAAUAAAAAAAEAAAADAAYAAAACAAEAAAADAAcAAAACAAIAAAADAAgAAAABAAIAAAADAAkAAAAAAAIAAAADAAoAAAABAAIAAAADAAsAAAACAAIAAAADAAwAAAAAAAIAAAADAA0AAAAAAAIAAAAEAAEAAAAAAAEAAAAEAAIAAAABAAEAAAAEAAMAAAACAAEAAAAEAAQAAAACAAEAAAAEAAUAAAABAAEAAAAEAAYAAAABAAIAAAAEAAcAAAABAAIAAAAEAAgAAAACAAIAAAAEAAkAAAAAAAIAAAAEAAoAAAAAAAIAAAAEAAsAAAAAAAIAAAAEAAwAAAACAAIAAAAEAA0AAAAAAAIAAAAFAAEAAAAAAAEAAAAFAAIAAAACAAEAAAAFAAMAAAAAAAEAAAAFAAQAAAAAAAEAAAAFAAUAAAACAAEAAAAFAAYAAAAAAAIAAAAFAAcAAAACAAIAAAAFAAgAAAACAAIAAAAFAAkAAAACAAIAAAAFAAoAAAACAAIAAAAFAAsAAAABAAIAAAAFAAwAAAAAAAIAAAAFAA0AAAABAAIAAAAGAAEAAAABAAEAAAAGAAIAAAABAAEAAAAGAAMAAAAAAAAAAAAGAAQAAAACAAAAAAAGAAUAAAAAAAAAAAAGAAYAAAABAAAAAAAGAAcAAAACAAAAAAAGAAgAAAACAAAAAAAGAAkAAAABAAQAAAAGAAoAAAABAAQAAAAGAAsAAAACAAAAAAAGAAwAAAABAAIAAAAGAA0AAAABAAIAAAAHAAEAAAABAAEAAAAHAAIAAAAAAAEAAAAHAAMAAAACAAAAAAAHAAQAAAABAAQAAAAHAAUAAAACAAQAAAAHAAYAAAAAAAQAAAAHAAcAAAABAAQAAAAHAAgAAAABAAQAAAAHAAkAAAAAAAQAAAAHAAoAAAAAAAQAAAAHAAsAAAABAAAAAAAHAAwAAAAAAAIAAAAHAA0AAAABAAIAAAAIAAEAAAABAAEAAAAIAAIAAAACAAEAAAAIAAMAAAABAAAAAAAIAAQAAAAAAAQAAAAIAAUAAAAAAAQAAAAIAAYAAAAAAAQAAAAIAAcAAAAAAAQAAAAIAAgAAAAAAAQAAAAIAAkAAAAAAAQAAAAIAAoAAAACAAQAAAAIAAsAAAACAAQAAAAIAAwAAAAAAAIAAAAIAA0AAAACAAIAAAAJAAEAAAAAAAEAAAAJAAIAAAABAAIAAAAJAAMAAAACAAAAAAAJAAQAAAABAAQAAAAJAAUAAAABAAQAAAAJAAYAAAAAAAAAAAAJAAcAAAABAAAAAAAJAAgAAAAAAAQAAAAJAAkAAAACAAQAAAAJAAoAAAACAAQAAAAJAAsAAAAAAAQAAAAJAAwAAAAAAAIAAAAJAA0AAAACAAIAAAAKAAEAAAACAAIAAAAKAAIAAAACAAIAAAAKAAMAAAAAAAAAAAAKAAQAAAAAAAQAAAAKAAUAAAACAAQAAAAKAAYAAAAAAAAAAAAKAAcAAAAAAAQAAAAKAAgAAAACAAQAAAAKAAkAAAAAAAQAAAAKAAoAAAAAAAQAAAAKAAsAAAABAAQAAAAKAAwAAAABAAIAAAAKAA0AAAABAAIAAAALAAEAAAABAAIAAAALAAIAAAABAAIAAAALAAMAAAABAAQAAAALAAQAAAACAAQAAAALAAUAAAACAAQAAAALAAYAAAACAAQAAAALAAcAAAAAAAQAAAALAAgAAAABAAQAAAALAAkAAAABAAQAAAALAAoAAAACAAQAAAALAAsAAAABAAAAAAALAAwAAAAAAAIAAAALAA0AAAABAAIAAAAMAAEAAAACAAIAAAAMAAIAAAACAAIAAAAMAAMAAAABAAQAAAAMAAQAAAABAAQAAAAMAAUAAAAAAAQAAAAMAAYAAAABAAQAAAAMAAcAAAACAAQAAAAMAAgAAAAAAAQAAAAMAAkAAAABAAQAAAAMAAoAAAAAAAQAAAAMAAsAAAABAAAAAAAMAAwAAAAAAAIAAAAMAA0AAAACAAIAAAANAAEAAAACAAIAAAANAAIAAAABAAIAAAANAAMAAAAAAAQAAAANAAQAAAABAAQAAAANAAUAAAACAAQAAAANAAYAAAAAAAQAAAANAAcAAAABAAQAAAANAAgAAAABAAQAAAANAAkAAAACAAQAAAANAAoAAAACAAQAAAANAAsAAAABAAAAAAANAAwAAAABAAIAAAANAA0AAAABAAIAAAAOAAEAAAACAAIAAAAOAAIAAAABAAIAAAAOAAMAAAAAAAAAAAAOAAQAAAAAAAQAAAAOAAUAAAAAAAQAAAAOAAYAAAAAAAAAAAAOAAcAAAACAAQAAAAOAAgAAAACAAQAAAAOAAkAAAABAAQAAAAOAAoAAAAAAAQAAAAOAAsAAAABAAQAAAAOAAwAAAABAAIAAAAOAA0AAAABAAIAAAAPAAEAAAAAAAEAAAAPAAIAAAACAAIAAAAPAAMAAAABAAAAAAAPAAQAAAACAAQAAAAPAAUAAAAAAAQAAAAPAAYAAAACAAAAAAAPAAcAAAABAAAAAAAPAAgAAAABAAQAAAAPAAkAAAACAAQAAAAPAAoAAAAAAAQAAAAPAAsAAAACAAQAAAAPAAwAAAABAAIAAAAPAA0AAAACAAIAAAAQAAEAAAAAAAEAAAAQAAIAAAABAAIAAAAQAAMAAAAAAAAAAAAQAAQAAAACAAQAAAAQAAUAAAACAAQAAAAQAAYAAAABAAQAAAAQAAcAAAACAAQAAAAQAAgAAAABAAQAAAAQAAkAAAACAAQAAAAQAAoAAAABAAQAAAAQAAsAAAACAAQAAAAQAAwAAAACAAIAAAAQAA0AAAABAAIAAAARAAEAAAAAAAEAAAARAAIAAAACAAEAAAARAAMAAAACAAAAAAARAAQAAAAAAAQAAAARAAUAAAACAAQAAAARAAYAAAACAAQAAAARAAcAAAAAAAQAAAARAAgAAAACAAQAAAARAAkAAAABAAQAAAARAAoAAAABAAQAAAARAAsAAAACAAAAAAARAAwAAAABAAIAAAARAA0AAAACAAIAAAASAAEAAAAAAAEAAAASAAIAAAABAAEAAAASAAMAAAAAAAAAAAASAAQAAAABAAAAAAASAAUAAAABAAAAAAASAAYAAAABAAAAAAASAAcAAAACAAAAAAASAAgAAAAAAAAAAAASAAkAAAAAAAQAAAASAAoAAAACAAQAAAASAAsAAAAAAAAAAAASAAwAAAABAAIAAAASAA0AAAACAAIAAAATAAEAAAAAAAEAAAATAAIAAAAAAAEAAAATAAMAAAABAAEAAAATAAQAAAAAAAEAAAATAAUAAAACAAEAAAATAAYAAAAAAAEAAAATAAcAAAAAAAIAAAATAAgAAAAAAAIAAAATAAkAAAAAAAIAAAATAAoAAAAAAAIAAAATAAsAAAAAAAIAAAATAAwAAAABAAIAAAATAA0AAAAAAAIAAAAUAAEAAAABAAEAAAAUAAIAAAABAAEAAAAUAAMAAAACAAEAAAAUAAQAAAAAAAEAAAAUAAUAAAABAAEAAAAUAAYAAAACAAIAAAAUAAcAAAACAAIAAAAUAAgAAAACAAIAAAAUAAkAAAAAAAIAAAAUAAoAAAAAAAIAAAAUAAsAAAACAAIAAAAUAAwAAAABAAIAAAAUAA0AAAAAAAIAAAAVAAEAAAACAAEAAAAVAAIAAAAAAAEAAAAVAAMAAAAAAAEAAAAVAAQAAAAAAAEAAAAVAAUAAAABAAEAAAAVAAYAAAABAAIAAAAVAAcAAAACAAIAAAAVAAgAAAACAAIAAAAVAAkAAAABAAIAAAAVAAoAAAABAAIAAAAVAAsAAAABAAIAAAAVAAwAAAAAAAIAAAAVAA0AAAACAAIAAAAWAAEAAAABAAEAAAAWAAIAAAABAAEAAAAWAAMAAAACAAEAAAAWAAQAAAAAAAEAAAAWAAUAAAABAAEAAAAWAAYAAAABAAIAAAAWAAcAAAACAAIAAAAWAAgAAAAAAAIAAAAWAAkAAAAAAAIAAAAWAAoAAAABAAIAAAAWAAsAAAABAAIAAAAWAAwAAAACAAIAAAAWAA0AAAAAAAIAAAAXAAEAAAACAAEAAAAXAAIAAAACAAEAAAAXAAMAAAAAAAEAAAAXAAQAAAAAAAEAAAAXAAUAAAAAAAIAAAAXAAYAAAACAAIAAAAXAAcAAAABAAIAAAAXAAgAAAAAAAIAAAAXAAkAAAABAAIAAAAXAAoAAAACAAIAAAAXAAsAAAABAAIAAAAXAAwAAAACAAIAAAAXAA0AAAABAAIAAAA=")
tile_set = ExtResource("2_o05f1")

[node name="PlayerCharacter" parent="." instance=ExtResource("5_u1iuh")]
position = Vector2(200, 152)
